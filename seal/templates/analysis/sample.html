{% extends 'base.html' %}


{% block content %}
	{% include 'includes/sidebar.j2' %}
	<div class="w3-main" style="margin-left:350px">
		<div class="w3-bar w3-flat-silver w3-left-align w3-padding">
			<h3><i class="fas fa-user-tag"></i> <i>{{ sample.samplename }}</i></h3>
		</div>
		<div class="w3-padding">
			<table cellspacing="5" cellpadding="5" border="0">
		        <tbody><tr>
		            <td>Gnomad Max:</td>
		            <td><input type="text" id="gnomadMax" name="gnomadMax" value="{{ filter.gnomAD_AF }}"></td>
		        </tr>
		    </tbody></table>
			<table id="variants" class="w3-table-all" style="width:100%">
				<thead>
					<tr class="w3-flat-green-sea">
						<th class='showTitle control-size-100'>Gene</th>
						<th class='showTitle control-size-100'>Feature</th>
						<th class='showTitle control-size-100'>Canonical</th>
						<th class='showTitle control-size-100'>Exon/Intron</th>
                        <th class='showTitle control-size-300'>HGVSg</th>
                        <th class='showTitle control-size-300'>HGVSc</th>
						<th class='showTitle control-size-300'>HGVSp</th>
						<th class='showTitle control-size-100'>GnomAD</th>
						<th class='showTitle control-size-300'>ClinSig</th>
						<th class='showTitle control-size-100'>Impact</th>
                        <th class='showTitle control-size-300'>Consequence</th>
					</tr>
				</thead>
				<tfoot>
					<tr class="w3-flat-green-sea">
						<th class='showTitle control-size-100'>Gene</th>
						<th class='showTitle control-size-100'>Feature</th>
						<th class='showTitle control-size-100'>Canonical</th>
						<th class='showTitle control-size-100'>Exon/Intron</th>
                        <th class='showTitle control-size-300'>HGVSg</th>
                        <th class='showTitle control-size-300'>HGVSc</th>
						<th class='showTitle control-size-300'>HGVSp</th>
						<th class='showTitle control-size-100'>GnomAD</th>
						<th class='showTitle control-size-300'>ClinSig</th>
						<th class='showTitle control-size-100'>Impact</th>
                        <th class='showTitle control-size-300'>Consequence</th>
					</tr>
				</tfoot>
			</table>
		</div>

	</div>
{% endblock %}


{% block script %}

	const clinsig_dict = {
		"uncertain_significance": {
			"color": "orange",
			"score": 4
		},
		"conflicting_interpretations_of_pathogenicity": {
			"color": "orange",
			"score": 4
		},
		"pathogenic": {
			"color": "alizarin",
			"score": 10
		},
		"likely_pathogenic": {
			"color": "alizarin",
			"score": 7
		},
		"pathogenic/likely_pathogenic": {
			"color": "alizarin",
			"score": 6
		},
		"benign": {
			"color": "turquoise",
			"score": -1.5
		},
		"likely_benign": {
			"color": "turquoise",
			"score": -0.25
		},
		"benign/likely_benign": {
			"color": "turquoise",
			"score": -1
		},
		"not_provided": {
			"color": "peter-river",
			"score": 0
		},
		"other": {
			"color": "peter-river",
			"score": 0
		},
		"protective": {
			"color": "peter-river",
			"score": 0
		},
		"association": {
			"color": "peter-river",
			"score": 0
		},
		"risk_factor": {
			"color": "peter-river",
			"score": 0
		},
		"affects": {
			"color": "peter-river",
			"score": 0
		}
	};

	const impact_dict = {
		"MODERATE": {
			"color": "orange",
			"score" : 2
		},
		"MODIFIER": {
			"color": "orange",
			"score" : 1.5
		},
		"HIGH": {
			"color": "alizarin",
			"score" : 3
		},
		"LOW": {
			"color": "turquoise",
			"score" : 1
		}
	};

	const consequences_dict = {
		"stop_gained": {
			"color": "ff0000",
			"score": 0,
		},
		"stop_lost": {
			"color": "ff0000",
			"score": 0,
		},
		"splice_acceptor_variant": {
			"color": "FF581A",
			"score": 0,
		},
		"splice_donor_variant": {
			"color": "FF581A",
			"score": 0,
		},
		"frameshift_variant": {
			"color": "9400D3",
			"score": 0,
		},
		"transcript_ablation": {
			"color": "ff0000",
			"score": 0,
		},
		"start_lost": {
			"color": "ffd700",
			"score": 0,
		},
		"transcript_amplification": {
			"color": "ff69b4",
			"score": 0,
		},
		"missense_variant": {
			"color": "ffd700",
			"score": 0,
		},
		"protein_altering_variant": {
			"color": "ff0080",
			"score": 0,
		},
		"splice_region_variant": {
			"color": "ff7f50",
			"score": 0,
		},
		"inframe_insertion": {
			"color": "ff69b4",
			"score": 0,
		},
		"inframe_deletion": {
			"color": "ff69b4",
			"score": 0,
		},
		"incomplete_terminal_codon_variant": {
			"color": "ff00ff",
			"score": 0,
		},
		"stop_retained_variant": {
			"color": "76ee00",
			"score": 0,
		},
		"start_retained_variant": {
			"color": "76ee00",
			"score": 0,
		},
		"synonymous_variant": {
			"color": "76ee00",
			"score": 0,
		},
		"coding_sequence_variant": {
			"color": "458b00",
			"score": 0,
		},
		"mature_miRNA_variant": {
			"color": "458b00",
			"score": 0,
		},
		"intron_variant": {
			"color": "02599c",
			"score": 0,
		},
		"NMD_transcript_variant": {
			"color": "ff4500",
			"score": 0,
		},
		"non_coding_transcript_exon_variant": {
			"color": "32cd32",
			"score": 0,
		},
		"non_coding_transcript_variant": {
			"color": "32cd32",
			"score": 0,
		},
		"3_prime_UTR_variant": {
			"color": "7ac5cd",
			"score": 0,
		},
		"5_prime_UTR_variant": {
			"color": "7ac5cd",
			"score": 0,
		},
		"upstream_gene_variant": {
			"color": "a2b5cd",
			"score": 0,
		},
		"downstream_gene_variant": {
			"color": "a2b5cd",
			"score": 0,
		},
		"TFBS_ablation": {
			"color": "a52a2a",
			"score": 0,
		},
		"TFBS_amplification": {
			"color": "a52a2a",
			"score": 0,
		},
		"TF_binding_site_variant": {
			"color": "a52a2a",
			"score": 0,
		},
		"regulatory_region_ablation": {
			"color": "a52a2a",
			"score": 0,
		},
		"regulatory_region_amplification": {
			"color": "a52a2a",
			"score": 0,
		},
		"regulatory_region_variant": {
			"color": "a52a2a",
			"score": 0,
		},
		"feature_elongation": {
			"color": "7f7f7f",
			"score": 0,
		},
		"feature_truncation": {
			"color": "7f7f7f",
			"score": 0,
		},
		"intergenic_variant": {
			"color": "636363",
			"score": 0,
		}
	};

	$(document).ready(function() {
	    table = $('#variants').DataTable({
			scrollX: true,
    		ajax: '/json/variants/sample/{{ sample.id }}',
    		"columns": [
				{ "className": 'showTitle control-size-100', "data": "annotations.SYMBOL"},
				{ "className": 'showTitle control-size-100', "data": "annotations.Feature"},
				{
					"className": 'showTitle control-size-100',
					"data": "annotations.canonical",
	                "render": {
						"_": function ( data, type, row ) {
							return data;
						},
						"display": function ( data, type, row ) {
							if (data) {
								response = '<i title="CANONICAL" class="w3-text-flat-peter-river fas fa-star"></i>';
							} else {
								response = '<i title="" class="w3-text-flat-peter-river far fa-star"></i>';
							}
							return response;
		                },
					},
				},
				{
					"className": 'showTitle control-size-100',
					"data": "annotations.EI",
					"render": {
						"_": function ( data, type, row ) {
							return data;
						},
						"sort": function ( data, type, row ) {
							pos_split = data.split(/\s|\//);
							if(pos_split[0] == "Exon") {
								myvar = Number(pos_split[1]).toString().padStart(4, "0") + "_" + Number(pos_split[2]).toString().padStart(4, "0") + "_0";
							} else if (pos_split[0] == "Intron") {
								myvar = Number(pos_split[1]).toString().padStart(4, "0") + "_" + Number(pos_split[2]).toString().padStart(4, "0") + "_1";
							} else {
								myvar = "NA"
							}
							console.log(myvar);
							return myvar
						},
					}
				},
				{ "className": 'showTitle control-size-300', "data": "annotations.HGVSg"},
				{ "className": 'showTitle control-size-300', "data": "annotations.HGVSc"},
				{ "className": 'showTitle control-size-300', "data": "annotations.HGVSp"},
				{
					"className": 'showTitle control-size-100',
					"data": "annotations.gnomADg_AF_EAS",
					"render" : {
						"_" : function ( data, type, row, meta ) {
							if(data != null) {
					    		return data.toFixed(6);
							} else {
								return "NA";
							}
					    },
	            		"sort" : function ( data, type, row, meta ) {
							if(data != null) {
					    		return data.toFixed(6);
							} else {
								num = -1
								return num.toFixed(6);
							}
					    }
					},
				},
				{
					"className": 'showTitle size-300',
					"data": "annotations.CLIN_SIG",
					"render": {
						"_": function ( data, type, row, meta ) {
							cell = {
								"orange": "",
								"alizarin": "",
								"turquoise": "",
								"peter-river": "",
								"asbestos": ""
							}
							style = "style='max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;'";

							for (idx in data) {
								color = data[idx] in clinsig_dict ? clinsig_dict[data[idx]]["color"] : "asbestos"
								cell[color] += " <span class='w3-tag w3-flat-" + color + "' " + style + ">" + data[idx] + "</span>"
							}
							return cell["orange"] + cell["alizarin"] + cell["turquoise"] + cell["peter-river"] + cell["asbestos"];
					    },
						"filter": function ( data, type, row, meta ) {
							return data.toString();
					    },
						"sort": function ( data, type, row, meta ) {
							score = 0;
							for (idx in data) {
								score += data[idx] in clinsig_dict ? clinsig_dict[data[idx]]["score"] : 0
							}
							return score;
					    },
					}
				},
				{
					"className": 'showTitle size-100',
					"data": "annotations.IMPACT",
					"render": {
						"_": function ( data, type, row, meta ) {
							style = "style='max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;'";
							cell = "<span class='w3-tag w3-flat-" + impact_dict[data]["color"] + "' " + style + ">" + data + "</span>";
							return cell;
					    },
						"filter": function ( data, type, row, meta ) {
							return data.toString();
					    },
						"sort": function ( data, type, row, meta ) {
							return impact_dict[data]["score"];
					    },
					}

				},
				{
					"className": 'showTitle size-300',
					"data": "annotations.Consequence",
					"render": {
						"_": function ( data, type, row, meta ) {
							cell = "";
							for (idx in consequences_dict) {
								if (data.includes(idx)){
									color = idx in consequences_dict ? consequences_dict[idx]["color"] : "7f8c8d";
									style = "style='max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;background-color:#" + color + ";'";
									cell += " <span class='w3-tag' " + style + ">" + idx + "</span>"
								}
							}
							return cell;
					    },
						"filter": function ( data, type, row, meta ) {
							return data.toString();
					    },
						"sort": function ( data, type, row, meta ) {
							sort = "A";
							for (idx in consequences_dict) {
								sort += data.includes(idx) ? "1" : "0";
							}
							return sort;
					    }
					},
				},
			]
		});

	      // Event listener to the two range filtering inputs to redraw on input
	      $('#gnomadMax').keyup( function() {
	          table.draw();
	      } );

	} );

	// Script to open and close sidebar
	function w3_open() {
		document.getElementById("sidebar").style.display = "block";
		document.getElementById("overlay").style.display = "block";
	}

	function w3_close() {
		document.getElementById("sidebar").style.display = "none";
		document.getElementById("overlay").style.display = "none";
	}

	$.fn.dataTable.ext.search.push(
	    function( settings, data, dataIndex ) {
	        var gnomadMax = parseFloat( $('#gnomadMax').val());
	        var gnomaAD_AF = parseFloat( data[6] ) || 0; // use data for the age column

	        if ( isNaN( gnomadMax ) || ( gnomaAD_AF <= gnomadMax ) )
	        {
	            return true;
	        }
	        return false;
	    }
	);

{% endblock %}
