{% extends 'base.html' %}

{% block static %}
    <style>
        .access:hover {
            cursor: pointer;
        }
        .disabled:hover {
            cursor: not-allowed;
        }
        .load:hover {
            cursor: wait;
        }
        .help:hover {
            cursor: help;
        }
    </style>
{% endblock %}

{% block content %}
    {% include 'includes/sidebar.j2' %}
    <div class="w3-main" {% if current_user.sidebar %}style="margin-left:350px"{% endif %}>
        <div class="w3-padding">
            <table id="samples" class="w3-table-all" style="width:100%">
                <thead>
                    <tr>
                        <th class="w3-flat-green-sea"><div>Sample Name</div></th>
                        <th class="w3-flat-green-sea"><div>Family</div></th>
                        <th class="w3-flat-green-sea"><div>Run</div></th>
                        <th class="w3-flat-green-sea"><div>Run Alias</div></th>
                        <th class="w3-flat-green-sea"><div>Status</div></th>
                        <th class="w3-flat-green-sea"><div>Team(s)</div></th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th class="w3-flat-green-sea"><div>Sample Name</div></th>
                        <th class="w3-flat-green-sea"><div>Family</div></th>
                        <th class="w3-flat-green-sea"><div>Run</div></th>
                        <th class="w3-flat-green-sea"><div>Run Alias</div></th>
                        <th class="w3-flat-green-sea"><div>Status</div></th>
                        <th class="w3-flat-green-sea"><div>Team(s)</div></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
{% endblock %}

{% block script %}
<script type="text/javascript">
    function view_sample(id) {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}");
                }
            }
        });

        $.ajax({
            type: "POST",
            url: "/toggle/sample/status",
            data: {
                "sample_id": id
            },
            success: function() {
                document.location.href = "/sample/" + id;
            }
        });
    }

    function toggle_status(id, status) {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}");
                }
            }
        });

        $.ajax({
            type: "POST",
            url: "/toggle/sample/status",
            data: {
                "sample_id": id,
                "status": status
            },
            success: function() {
                if (status == 1) {
                    response = '<span class="w3-text-flat-peter-river"><i class="fas fa-user-clock"></i> <i><b>New</b> - new sample</i></span>';
                } else if (status == 2) {
                    response = '<span class="w3-text-flat-peter-river"><i class="fas fa-user-edit"></i> <i><b>Process</b> - analysing</i></span>';
                } else if (status == 3) {
                    response = '<span class="w3-text-flat-emerald"><i class="fas fa-user-check"></i> <i><b>Validate</b> - analysed</i></span>';
                }
                document.getElementById("button-status-" + id).innerHTML = response;
            }
        });
    }

    $(document).ready(function() {
        table = $('#samples').DataTable({
            scrollX: true,
            proccessing: true,
            serverSide: true,
            ajax: {
                url: '/json/samples',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                },
            },
            columns: [
                {
                    className: 'showTitle',
                    data: {
                        _: "samplename",
                        display: function ( data, type, row ) {
                            if(data) {
                                return '<button onclick="view_sample(' + data.id + ')" class="w3-button w3-hover-flat-green-sea">' + data.samplename + '</button>';
                            }
                            return data
                        }
                    }
                },
                { className: 'showTitle', data: "family" },
                { className: 'showTitle', data: "run.name" },
                { className: 'showTitle', data: "run.alias" },
                {
                    className: 'showTitle ',
                    data: {
                        _: "status",
                        display: function ( data, type, row ) {
                            response = "";
                            if(data) {
                                if (data.status == -1) {
                                    response = '<span class="w3-text-flat-alizarin"><i title="Error" class="fas fa-times-circle"></i> <i><b>Error</b> - contact admin</i></span>';
                                } else if (data.status == 0) {
                                    response = '<span class="w3-text-flat-wet-asphalt"><i class="fas fa-cloud-download-alt"></i> <i><b>Upload</b> - in progress</i></span>';
                                } else if (data.status == 1) {
                                    response = '<span class="w3-text-flat-peter-river"><i class="fas fa-user-clock"></i> <i><b>New</b> - new sample</i></span>';
                                } else if (data.status == 2) {
                                    response = '<span class="w3-text-flat-peter-river"><i class="fas fa-user-edit"></i> <i><b>Process</b> - analysing</i></span>';
                                } else if (data.status == 3) {
                                    response = '<span class="w3-text-flat-emerald"><i class="fas fa-user-check"></i> <i><b>Validate</b> - analysed</i></span>';
                                }  else {
                                    response = '<span class="w3-text-flat-orange"><i class="fas fa-exclamation-triangle"></i> <i><b>Warning</b> - contact admin</i></span>';
                                }
                                sample_id = data.id
                                response = `<div class="w3-dropdown-hover w3-right" style="background-color:transparent">
                                    <button class="w3-button" id="button-status-` + sample_id + `">
                                        ` + response + `
                                    </button>
                                    <div class="w3-dropdown-content w3-bar-block" style="right:0">
                                        <a onclick="toggle_status(` + sample_id + `, 1)" class="w3-border-top w3-border-right w3-border-left w3-bar-item w3-button">
                                            <span class="w3-text-flat-peter-river"><i class="fas fa-user-clock"></i> <i><b>New</b> - new sample</i></span>
                                        </a>
                                        <a onclick="toggle_status(` + sample_id + `, 2)" class="w3-border-right w3-border-left w3-bar-item w3-button">
                                            <span class="w3-text-flat-peter-river"><i class="fas fa-user-edit"></i> <i><b>Process</b> - analysing</i></span>
                                        </a>
                                        <a onclick="toggle_status(` + sample_id + `, 3)" class="w3-border-right w3-border-left w3-border-bottom w3-bar-item w3-button">
                                            <span class="w3-text-flat-emerald"><i class="fas fa-user-check"></i> <i><b>Validate</b> - analysed</i></span>
                                        </a>
                                    </div>
                                </div>`
                            }
                            return response;
                        },
                    }
                },
                {
                    className: 'showTitle',
                    orderable: false,
                    data: "teams",
                    render : {
                        _: function ( data, type, row ) {
                            if (data.length >= 1) {
                                teams = ""
                                for (i in data) {
                                    teams += '<span class="w3-tag" style="max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;background-color:' + data[i]["color"] + '">' + data[i]["teamname"] + '</span>'
                                };
                                return teams
                            }
                            return "NA"
                        }
                    }
                }
            ],
            createdRow: function( row, data, dataIndex ) {
                if ( data.status < 1 || data.status > 3) {
                    $(row).addClass( 'w3-disabled' );
                }
            }
        });
    } );
</script>
{% endblock %}
